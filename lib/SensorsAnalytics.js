"use strict";

require("core-js/modules/es.symbol.description");

require("core-js/modules/es.symbol.async-iterator");

require("core-js/modules/es.symbol.species");

require("core-js/modules/es.array.concat");

require("core-js/modules/es.array.filter");

require("core-js/modules/es.array.flat");

require("core-js/modules/es.array.flat-map");

require("core-js/modules/es.array.from");

require("core-js/modules/es.array.includes");

require("core-js/modules/es.array.index-of");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.array.last-index-of");

require("core-js/modules/es.array.map");

require("core-js/modules/es.array.slice");

require("core-js/modules/es.array.sort");

require("core-js/modules/es.array.species");

require("core-js/modules/es.array.splice");

require("core-js/modules/es.array.unscopables.flat");

require("core-js/modules/es.array.unscopables.flat-map");

require("core-js/modules/es.function.has-instance");

require("core-js/modules/es.map");

require("core-js/modules/es.math.acosh");

require("core-js/modules/es.math.hypot");

require("core-js/modules/es.object.define-getter");

require("core-js/modules/es.object.define-setter");

require("core-js/modules/es.object.entries");

require("core-js/modules/es.object.from-entries");

require("core-js/modules/es.object.get-own-property-descriptors");

require("core-js/modules/es.object.lookup-getter");

require("core-js/modules/es.object.lookup-setter");

require("core-js/modules/es.object.values");

require("core-js/modules/es.promise");

require("core-js/modules/es.promise.finally");

require("core-js/modules/es.regexp.constructor");

require("core-js/modules/es.set");

require("core-js/modules/es.string.ends-with");

require("core-js/modules/es.string.includes");

require("core-js/modules/es.string.match");

require("core-js/modules/es.string.pad-end");

require("core-js/modules/es.string.pad-start");

require("core-js/modules/es.string.replace");

require("core-js/modules/es.string.search");

require("core-js/modules/es.string.split");

require("core-js/modules/es.string.starts-with");

require("core-js/modules/es.string.trim");

require("core-js/modules/es.string.trim-end");

require("core-js/modules/es.string.trim-start");

require("core-js/modules/es.typed-array.float32-array");

require("core-js/modules/es.typed-array.float64-array");

require("core-js/modules/es.typed-array.int8-array");

require("core-js/modules/es.typed-array.int16-array");

require("core-js/modules/es.typed-array.int32-array");

require("core-js/modules/es.typed-array.uint8-array");

require("core-js/modules/es.typed-array.uint8-clamped-array");

require("core-js/modules/es.typed-array.uint16-array");

require("core-js/modules/es.typed-array.uint32-array");

require("core-js/modules/es.typed-array.from");

require("core-js/modules/es.typed-array.of");

require("core-js/modules/es.typed-array.to-string");

require("core-js/modules/es.weak-map");

require("core-js/modules/es.weak-set");

require("core-js/modules/esnext.aggregate-error");

require("core-js/modules/esnext.array.last-index");

require("core-js/modules/esnext.array.last-item");

require("core-js/modules/esnext.composite-key");

require("core-js/modules/esnext.composite-symbol");

require("core-js/modules/esnext.global-this");

require("core-js/modules/esnext.map.delete-all");

require("core-js/modules/esnext.map.every");

require("core-js/modules/esnext.map.filter");

require("core-js/modules/esnext.map.find");

require("core-js/modules/esnext.map.find-key");

require("core-js/modules/esnext.map.from");

require("core-js/modules/esnext.map.group-by");

require("core-js/modules/esnext.map.includes");

require("core-js/modules/esnext.map.key-by");

require("core-js/modules/esnext.map.key-of");

require("core-js/modules/esnext.map.map-keys");

require("core-js/modules/esnext.map.map-values");

require("core-js/modules/esnext.map.merge");

require("core-js/modules/esnext.map.of");

require("core-js/modules/esnext.map.reduce");

require("core-js/modules/esnext.map.some");

require("core-js/modules/esnext.map.update");

require("core-js/modules/esnext.math.clamp");

require("core-js/modules/esnext.math.deg-per-rad");

require("core-js/modules/esnext.math.degrees");

require("core-js/modules/esnext.math.fscale");

require("core-js/modules/esnext.math.iaddh");

require("core-js/modules/esnext.math.imulh");

require("core-js/modules/esnext.math.isubh");

require("core-js/modules/esnext.math.rad-per-deg");

require("core-js/modules/esnext.math.radians");

require("core-js/modules/esnext.math.scale");

require("core-js/modules/esnext.math.seeded-prng");

require("core-js/modules/esnext.math.signbit");

require("core-js/modules/esnext.math.umulh");

require("core-js/modules/esnext.number.from-string");

require("core-js/modules/esnext.observable");

require("core-js/modules/esnext.promise.all-settled");

require("core-js/modules/esnext.promise.any");

require("core-js/modules/esnext.promise.try");

require("core-js/modules/esnext.reflect.define-metadata");

require("core-js/modules/esnext.reflect.delete-metadata");

require("core-js/modules/esnext.reflect.get-metadata");

require("core-js/modules/esnext.reflect.get-metadata-keys");

require("core-js/modules/esnext.reflect.get-own-metadata");

require("core-js/modules/esnext.reflect.get-own-metadata-keys");

require("core-js/modules/esnext.reflect.has-metadata");

require("core-js/modules/esnext.reflect.has-own-metadata");

require("core-js/modules/esnext.reflect.metadata");

require("core-js/modules/esnext.set.add-all");

require("core-js/modules/esnext.set.delete-all");

require("core-js/modules/esnext.set.difference");

require("core-js/modules/esnext.set.every");

require("core-js/modules/esnext.set.filter");

require("core-js/modules/esnext.set.find");

require("core-js/modules/esnext.set.from");

require("core-js/modules/esnext.set.intersection");

require("core-js/modules/esnext.set.is-disjoint-from");

require("core-js/modules/esnext.set.is-subset-of");

require("core-js/modules/esnext.set.is-superset-of");

require("core-js/modules/esnext.set.join");

require("core-js/modules/esnext.set.map");

require("core-js/modules/esnext.set.of");

require("core-js/modules/esnext.set.reduce");

require("core-js/modules/esnext.set.some");

require("core-js/modules/esnext.set.symmetric-difference");

require("core-js/modules/esnext.set.union");

require("core-js/modules/esnext.string.at");

require("core-js/modules/esnext.string.code-points");

require("core-js/modules/esnext.string.match-all");

require("core-js/modules/esnext.string.replace-all");

require("core-js/modules/esnext.symbol.dispose");

require("core-js/modules/esnext.symbol.observable");

require("core-js/modules/esnext.symbol.pattern-match");

require("core-js/modules/esnext.weak-map.delete-all");

require("core-js/modules/esnext.weak-map.from");

require("core-js/modules/esnext.weak-map.of");

require("core-js/modules/esnext.weak-set.add-all");

require("core-js/modules/esnext.weak-set.delete-all");

require("core-js/modules/esnext.weak-set.from");

require("core-js/modules/esnext.weak-set.of");

require("core-js/modules/web.queue-microtask");

require("core-js/modules/web.url");

require("core-js/modules/web.url.to-json");

require("core-js/modules/web.url-search-params");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _ramda = _interopRequireDefault(require("ramda"));

var _rx = require("rx");

var _debug = _interopRequireDefault(require("debug"));

var _translators = require("./translators");

var _readPackageInfo = require("./readPackageInfo");

var _assertions = require("./assertions");

var _Submitter = _interopRequireDefault(require("./Submitter"));

var _LoggingConsumer = _interopRequireDefault(require("./LoggingConsumer"));

var _NWConsumer = _interopRequireDefault(require("./NWConsumer"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debug.default)("sa:SensorsAnalytics");
const SDK_PROPERTIES = {
  $lib: "Node",
  $libVersion: _readPackageInfo.version
};

class SensorsAnalytics extends _rx.Subject {
  constructor() {
    super();
    this.logger = null;
    this.loggingConsumer = false;
    this.enableReNameOption();
    this.clearSuperProperties();
  }

  disableLoggingConsumer() {
    this.loggingConsumer = false;
  }

  enableLoggingConsumer() {
    this.loggingConsumer = true;
  }

  registerSuperProperties(values = {}) {
    debug("registerSuperProperties(%j)", values);
    (0, _assertions.checkProperties)(values, _assertions.checkPattern);
    (0, _assertions.checkProperties)(values, _assertions.checkValueType);
    return Object.assign(this.superProperties, values);
  }

  clearSuperProperties() {
    debug("clearSuperProperties()");
    this.superProperties = {};
    return this.superProperties;
  }

  disableReNameOption() {
    debug("resetReNameOption()");
    this.allowReNameOption = false;
    return this.allowReNameOption;
  }

  enableReNameOption() {
    debug("resetReNameOption()");
    this.allowReNameOption = true;
    return this.allowReNameOption;
  }

  superizeProperties(properties = {}, callIndex) {
    // 合并公共属性
    const codeProperties = (0, _translators.extractCodeProperties)(callIndex);
    return {
      properties: _ramda.default.mergeAll([this.superProperties, (0, _translators.translateUserAgent)(properties)]),
      lib: (0, _translators.snakenizeKeys)(_ramda.default.mergeAll([SDK_PROPERTIES, codeProperties, {
        $app_version: this.superProperties.$app_version || this.superProperties.$appVersion || properties.$app_version || properties.$appVersion
      }]))
    };
  }

  track(distinctId, event, eventProperties) {
    debug("track(%j)", {
      distinctId,
      event,
      eventProperties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkPattern)(event, "event");
    (0, _assertions.checkProperties)(eventProperties, _assertions.checkValueType);
    const superize = this.superizeProperties(eventProperties, 4);
    this.internalTrack("track", {
      event,
      distinctId,
      properties: _ramda.default.mergeAll([(0, _translators.snakenizeKeys)(SDK_PROPERTIES), superize.properties]),
      lib: superize.lib
    });
  }

  trackSignup(distinctId, originalId, eventProperties) {
    debug("trackSignup(%j)", {
      distinctId,
      originalId,
      eventProperties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkExists)(originalId, "originalId");
    (0, _assertions.checkProperties)(eventProperties, _assertions.checkValueType);
    const superize = this.superizeProperties(eventProperties, 4);
    this.internalTrack("track_signup", {
      event: "$SignUp",
      distinctId,
      originalId,
      properties: _ramda.default.mergeAll([(0, _translators.snakenizeKeys)(SDK_PROPERTIES), superize.properties]),
      lib: superize.lib
    });
  }

  profileSet(distinctId, properties) {
    debug("profileSet(%j)", {
      distinctId,
      properties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkProperties)(properties, _assertions.checkValueType);
    const superize = this.superizeProperties(properties, 4);

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$app_version")) {
      delete superize.properties.$app_version;
    }

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$appVersion")) {
      delete superize.properties.$appVersion;
    }

    this.internalTrack("profile_set", {
      distinctId,
      properties: superize.properties,
      lib: superize.lib
    });
  }

  profileSetOnce(distinctId, properties) {
    debug("profileSetOnce(%j)", {
      distinctId,
      properties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkProperties)(properties, _assertions.checkValueType);
    const superize = this.superizeProperties(properties, 4);

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$app_version")) {
      delete superize.properties.$app_version;
    }

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$appVersion")) {
      delete superize.properties.$appVersion;
    }

    this.internalTrack("profile_set_once", {
      distinctId,
      properties: superize.properties,
      lib: superize.lib
    });
  }

  profileIncrement(distinctId, properties) {
    debug("profileIncrement(%j)", {
      distinctId,
      properties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkProperties)(properties, _assertions.checkValueIsNumber);
    const superize = this.superizeProperties(properties, 4);

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$app_version")) {
      delete superize.properties.$app_version;
    }

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$appVersion")) {
      delete superize.properties.$appVersion;
    }

    this.internalTrack("profile_increment", {
      distinctId,
      properties,
      lib: superize.lib
    });
  }

  profileAppend(distinctId, properties) {
    debug("profileAppend(%j)", {
      distinctId,
      properties
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkProperties)(properties, _assertions.checkValueIsStringArray);
    const superize = this.superizeProperties(properties, 4);

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$app_version")) {
      delete superize.properties.$app_version;
    }

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$appVersion")) {
      delete superize.properties.$appVersion;
    }

    this.internalTrack("profile_append", {
      distinctId,
      properties,
      lib: superize.lib
    });
  }

  profileUnset(distinctId, keys = []) {
    debug("profileUnset(%j)", {
      distinctId,
      keys
    });
    (0, _assertions.checkExists)(distinctId, "distinctId");
    (0, _assertions.checkIsStringArray)(keys, "Keys");

    const properties = _ramda.default.zipObj(keys, _ramda.default.repeat(true, keys.length));

    const superize = this.superizeProperties(properties, 4);

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$app_version")) {
      delete superize.properties.$app_version;
    }

    if (Object.prototype.hasOwnProperty.call(superize.properties, "$appVersion")) {
      delete superize.properties.$appVersion;
    }

    this.internalTrack("profile_unset", {
      distinctId,
      properties,
      lib: superize.lib
    });
  }

  itemSet(itemType, itemId, properties) {
    debug("itemSet(%j)", {
      itemType,
      itemId,
      properties
    });
    (0, _assertions.checkProperties)(properties, _assertions.checkValueType);
    const superize = this.superizeProperties(properties, 4);
    this.internalTrack("item_set", {
      itemType,
      itemId,
      properties,
      lib: superize.lib
    });
  }

  itemDelete(itemType, itemId) {
    debug("itemDelete(%j)", {
      itemType,
      itemId
    });
    const superize = this.superizeProperties({}, 4);
    this.internalTrack("item_delete", {
      itemType,
      itemId,
      properties: {},
      lib: superize.lib
    });
  }

  internalTrack(type, {
    event,
    distinctId,
    originalId,
    itemType,
    itemId,
    properties,
    lib
  }) {
    if (this.allowReNameOption) {
      properties = (0, _translators.snakenizeKeys)(properties);
      event = (0, _translators.pascal2Snake)(event);
    }

    const envelope = (0, _translators.snakenizeKeys)({
      _track_id: parseInt(Math.random() * (9999999999 - 999999999 + 1) + 999999999, 10),
      type,
      event,
      time: (0, _translators.extractTimestamp)(properties),
      distinctId,
      originalId,
      itemType,
      itemId,
      properties: (0, _assertions.checkProperties)(properties, _assertions.checkPattern),
      lib
    });
    debug("envelope: %j", envelope);

    if (this.loggingConsumer) {
      this.logger.send(envelope);
    } else {
      this.onNext(envelope);
    }
  }

  inBatch({
    count,
    timeSpan
  }) {
    const mode = `${count != null ? "count" : ""}${timeSpan != null ? "time" : ""}`;
    debug("inBatch(%j)", {
      count,
      timeSpan,
      mode
    });

    switch (mode) {
      case "count":
        return this.bufferWithCount(count).filter(events => events.length > 0);

      case "counttime":
        return this.bufferWithTimeOrCount(timeSpan, count).filter(events => events.length > 0);

      case "time":
        return this.bufferWithTime(timeSpan).filter(events => events.length > 0);

      default:
        return this;
    }
  }

  submitTo(options, batchOptions = {}) {
    debug("submitTo(%j, %j)", options, batchOptions);
    const observable = this.inBatch(batchOptions);
    const submitter = new _Submitter.default(options);
    observable.subscribe(submitter);
    return submitter;
  }

  initNWConsumer(options, batchOptions = {}) {
    debug("initNWConsumer(%j, %j)", options, batchOptions);
    const observable = this.inBatch(batchOptions);
    const submitter = new _NWConsumer.default(options);
    observable.subscribe(submitter);
    return submitter;
  }

  initLoggingConsumer(path, pm2Mode) {
    this.enableLoggingConsumer();
    this.logger = new _LoggingConsumer.default(path, pm2Mode);
  }

  close() {
    this.onCompleted();
    this.logger.close();
  }

}

var _default = SensorsAnalytics;
exports.default = _default;