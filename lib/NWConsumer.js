"use strict";

require("core-js/modules/es.symbol.description");

require("core-js/modules/es.symbol.async-iterator");

require("core-js/modules/es.symbol.species");

require("core-js/modules/es.array.concat");

require("core-js/modules/es.array.filter");

require("core-js/modules/es.array.flat");

require("core-js/modules/es.array.flat-map");

require("core-js/modules/es.array.from");

require("core-js/modules/es.array.includes");

require("core-js/modules/es.array.index-of");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.array.last-index-of");

require("core-js/modules/es.array.map");

require("core-js/modules/es.array.slice");

require("core-js/modules/es.array.sort");

require("core-js/modules/es.array.species");

require("core-js/modules/es.array.splice");

require("core-js/modules/es.array.unscopables.flat");

require("core-js/modules/es.array.unscopables.flat-map");

require("core-js/modules/es.function.has-instance");

require("core-js/modules/es.map");

require("core-js/modules/es.math.acosh");

require("core-js/modules/es.math.hypot");

require("core-js/modules/es.object.define-getter");

require("core-js/modules/es.object.define-setter");

require("core-js/modules/es.object.entries");

require("core-js/modules/es.object.from-entries");

require("core-js/modules/es.object.get-own-property-descriptors");

require("core-js/modules/es.object.lookup-getter");

require("core-js/modules/es.object.lookup-setter");

require("core-js/modules/es.object.values");

require("core-js/modules/es.promise");

require("core-js/modules/es.promise.finally");

require("core-js/modules/es.regexp.constructor");

require("core-js/modules/es.set");

require("core-js/modules/es.string.ends-with");

require("core-js/modules/es.string.includes");

require("core-js/modules/es.string.match");

require("core-js/modules/es.string.pad-end");

require("core-js/modules/es.string.pad-start");

require("core-js/modules/es.string.replace");

require("core-js/modules/es.string.search");

require("core-js/modules/es.string.split");

require("core-js/modules/es.string.starts-with");

require("core-js/modules/es.string.trim");

require("core-js/modules/es.string.trim-end");

require("core-js/modules/es.string.trim-start");

require("core-js/modules/es.typed-array.float32-array");

require("core-js/modules/es.typed-array.float64-array");

require("core-js/modules/es.typed-array.int8-array");

require("core-js/modules/es.typed-array.int16-array");

require("core-js/modules/es.typed-array.int32-array");

require("core-js/modules/es.typed-array.uint8-array");

require("core-js/modules/es.typed-array.uint8-clamped-array");

require("core-js/modules/es.typed-array.uint16-array");

require("core-js/modules/es.typed-array.uint32-array");

require("core-js/modules/es.typed-array.from");

require("core-js/modules/es.typed-array.of");

require("core-js/modules/es.typed-array.to-string");

require("core-js/modules/es.weak-map");

require("core-js/modules/es.weak-set");

require("core-js/modules/esnext.aggregate-error");

require("core-js/modules/esnext.array.last-index");

require("core-js/modules/esnext.array.last-item");

require("core-js/modules/esnext.composite-key");

require("core-js/modules/esnext.composite-symbol");

require("core-js/modules/esnext.global-this");

require("core-js/modules/esnext.map.delete-all");

require("core-js/modules/esnext.map.every");

require("core-js/modules/esnext.map.filter");

require("core-js/modules/esnext.map.find");

require("core-js/modules/esnext.map.find-key");

require("core-js/modules/esnext.map.from");

require("core-js/modules/esnext.map.group-by");

require("core-js/modules/esnext.map.includes");

require("core-js/modules/esnext.map.key-by");

require("core-js/modules/esnext.map.key-of");

require("core-js/modules/esnext.map.map-keys");

require("core-js/modules/esnext.map.map-values");

require("core-js/modules/esnext.map.merge");

require("core-js/modules/esnext.map.of");

require("core-js/modules/esnext.map.reduce");

require("core-js/modules/esnext.map.some");

require("core-js/modules/esnext.map.update");

require("core-js/modules/esnext.math.clamp");

require("core-js/modules/esnext.math.deg-per-rad");

require("core-js/modules/esnext.math.degrees");

require("core-js/modules/esnext.math.fscale");

require("core-js/modules/esnext.math.iaddh");

require("core-js/modules/esnext.math.imulh");

require("core-js/modules/esnext.math.isubh");

require("core-js/modules/esnext.math.rad-per-deg");

require("core-js/modules/esnext.math.radians");

require("core-js/modules/esnext.math.scale");

require("core-js/modules/esnext.math.seeded-prng");

require("core-js/modules/esnext.math.signbit");

require("core-js/modules/esnext.math.umulh");

require("core-js/modules/esnext.number.from-string");

require("core-js/modules/esnext.observable");

require("core-js/modules/esnext.promise.all-settled");

require("core-js/modules/esnext.promise.any");

require("core-js/modules/esnext.promise.try");

require("core-js/modules/esnext.reflect.define-metadata");

require("core-js/modules/esnext.reflect.delete-metadata");

require("core-js/modules/esnext.reflect.get-metadata");

require("core-js/modules/esnext.reflect.get-metadata-keys");

require("core-js/modules/esnext.reflect.get-own-metadata");

require("core-js/modules/esnext.reflect.get-own-metadata-keys");

require("core-js/modules/esnext.reflect.has-metadata");

require("core-js/modules/esnext.reflect.has-own-metadata");

require("core-js/modules/esnext.reflect.metadata");

require("core-js/modules/esnext.set.add-all");

require("core-js/modules/esnext.set.delete-all");

require("core-js/modules/esnext.set.difference");

require("core-js/modules/esnext.set.every");

require("core-js/modules/esnext.set.filter");

require("core-js/modules/esnext.set.find");

require("core-js/modules/esnext.set.from");

require("core-js/modules/esnext.set.intersection");

require("core-js/modules/esnext.set.is-disjoint-from");

require("core-js/modules/esnext.set.is-subset-of");

require("core-js/modules/esnext.set.is-superset-of");

require("core-js/modules/esnext.set.join");

require("core-js/modules/esnext.set.map");

require("core-js/modules/esnext.set.of");

require("core-js/modules/esnext.set.reduce");

require("core-js/modules/esnext.set.some");

require("core-js/modules/esnext.set.symmetric-difference");

require("core-js/modules/esnext.set.union");

require("core-js/modules/esnext.string.at");

require("core-js/modules/esnext.string.code-points");

require("core-js/modules/esnext.string.match-all");

require("core-js/modules/esnext.string.replace-all");

require("core-js/modules/esnext.symbol.dispose");

require("core-js/modules/esnext.symbol.observable");

require("core-js/modules/esnext.symbol.pattern-match");

require("core-js/modules/esnext.weak-map.delete-all");

require("core-js/modules/esnext.weak-map.from");

require("core-js/modules/esnext.weak-map.of");

require("core-js/modules/esnext.weak-set.add-all");

require("core-js/modules/esnext.weak-set.delete-all");

require("core-js/modules/esnext.weak-set.from");

require("core-js/modules/esnext.weak-set.of");

require("core-js/modules/web.queue-microtask");

require("core-js/modules/web.url");

require("core-js/modules/web.url.to-json");

require("core-js/modules/web.url-search-params");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _ramda = _interopRequireDefault(require("ramda"));

var _rx = require("rx");

var _url = _interopRequireDefault(require("url"));

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _zlib = _interopRequireDefault(require("mz/zlib"));

var _formUrlencoded = _interopRequireDefault(require("form-urlencoded"));

var _debug = _interopRequireDefault(require("debug"));

var _TaskQueue = _interopRequireDefault(require("./TaskQueue"));

var _db = _interopRequireDefault(require("./db"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const debug = (0, _debug.default)("sa:Submitter");
const DEFAULT_TIMEOUT = 10000;
const MODES = {
  track: {
    debug: false,
    dryRun: false
  },
  debug: {
    debug: true,
    dryRun: false
  },
  dryRun: {
    debug: true,
    dryRun: true
  },
  debug_off: {
    debug: false,
    dryRun: false
  },
  debug_and_track: {
    debug: true,
    dryRun: false
  },
  debug_only: {
    debug: true,
    dryRun: true
  }
};

class NWConsumer extends _rx.Subject {
  static composeDebugUrl(url) {
    return _url.default.format(_ramda.default.merge(_url.default.parse(url), {
      pathname: "/debug"
    }));
  }

  constructor({
    url,
    cachePath,
    gzip = true,
    mode = "track",
    timeout = DEFAULT_TIMEOUT
  }) {
    super();

    if (typeof arguments[0] === "string") {
      url = arguments[0];
    }

    if (url == null) {
      throw new Error("Url is not provided");
    }

    if (cachePath == null) {
      throw new Error("CachePath is not provided");
    }

    if (MODES[mode] == null) {
      throw new Error(`Unknown mode: ${mode}`);
    }

    Object.assign(this, {
      url,
      cachePath,
      gzip,
      timeout
    }, MODES[mode]);

    if (this.debug) {
      this.url = NWConsumer.composeDebugUrl(url);
    }

    debug("Config: %o", this);
    this.db = new _db.default(cachePath);
    this.dataQueue = new _TaskQueue.default({
      consumeData: this.submit.bind(this),
      onSucceeded: () => {
        super.onNext(null);
      },
      onError: this.onError.bind(this)
    });
    this.pushCache();
  }

  catch(callback) {
    debug("Error:");
    this.subscribe(_ramda.default.identity, callback, _ramda.default.identity);
  }

  onNext(data) {
    debug("onNext(%o)", data);
    this.dataQueue.enqueueAndStart(data);
  }

  pushCache() {
    var _this = this;

    return _asyncToGenerator(function* () {
      _this.db.uploadCache(message => {
        _this.submit(message).catch(err => {
          debug(err);
        });
      });
    })();
  }

  submit(data) {
    var _this2 = this;

    return _asyncToGenerator(function* () {
      if (data == null) {
        debug("Skiped due to empty data");
        return;
      }

      let message;

      if (data._id && data.message) {
        message = JSON.parse(data.message);
      } else {
        message = data;
      }

      const messages = Array.isArray(message) ? message : [message];

      if (messages.length === 0) {
        debug("Skiped due to empty batch data");
        return;
      }

      debug("submit(%j)", messages);
      const payloadText = new Buffer(JSON.stringify(messages), "utf8");
      const dataListBuffer = yield _this2.gzip ? _zlib.default.gzip(payloadText) : payloadText;
      const body = (0, _formUrlencoded.default)({
        data_list: dataListBuffer.toString("base64"),
        gzip: _this2.gzip ? 1 : 0
      });
      const headers = {
        "User-Agent": "SensorsAnalytics Node SDK",
        "Content-Type": "application/x-www-form-urlencoded",
        "Dry-Run": _this2.dryRun ? "true" : undefined
      };
      debug("Post to %s", _this2.url);
      debug("Headers: %o", headers);
      debug("Body: %o", body);
      debug("Posting...");
      (0, _nodeFetch.default)(_this2.url, {
        method: "POST",
        headers,
        body,
        timeout: _this2.timeout
      }).then(response => {
        debug("Post complete");

        if (response.ok) {
          debug("Suceeded: %d", response.status);

          if (data._id && data.message) {
            _this2.db.deleteEvent(data);
          }

          return;
        }

        debug("Error: %s", response.status);

        if (!(data._id && data.message)) {
          _this2.db.cacheLog(JSON.stringify(data));
        }

        if (_this2.debug && messages.count > 1 && response.status === 400) {
          debug("Batch mode is not supported in debug");
          throw new Error("Batch mode is not supported in Debug");
        }

        response.text().then(errorMessage => {
          throw new Error(errorMessage);
        });
      }).catch(err => {
        if (!(data._id && data.message)) {
          _this2.db.cacheLog(JSON.stringify(data));
        }

        debug(`timeout: ${err}`);
      });
    })();
  }

}

var _default = NWConsumer;
exports.default = _default;